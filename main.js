/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var G=Object.create;var v=Object.defineProperty;var H=Object.getOwnPropertyDescriptor;var A=Object.getOwnPropertyNames;var K=Object.getPrototypeOf,F=Object.prototype.hasOwnProperty;var O=(o,d)=>{for(var t in d)v(o,t,{get:d[t],enumerable:!0})},U=(o,d,t,n)=>{if(d&&typeof d=="object"||typeof d=="function")for(let c of A(d))!F.call(o,c)&&c!==t&&v(o,c,{get:()=>d[c],enumerable:!(n=H(d,c))||n.enumerable});return o};var I=(o,d,t)=>(t=o!=null?G(K(o)):{},U(d||!o||!o.__esModule?v(t,"default",{value:o,enumerable:!0}):t,o)),B=o=>U(v({},"__esModule",{value:!0}),o);var z={};O(z,{default:()=>R});module.exports=B(z);var h=require("obsidian"),x=I(require("path")),T=require("child_process"),N={githubRepoUrl:"",localMarkdownPath:"",gitPassword:""},R=class extends h.Plugin{async onload(){await this.loadSettings(),this.addRibbonIcon("cloud-lightning","Krems Publisher",t=>{new S(this.app,this).open()}),this.addSettingTab(new L(this.app,this)),console.log("Krems Obsidian Plugin loaded.")}onunload(){console.log("Krems Obsidian Plugin unloaded.")}async loadSettings(){this.settings=Object.assign({},N,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async execShellCommand(t,n){return new Promise((c,y)=>{(0,T.exec)(t,{cwd:n},(l,p,g)=>{if(l){console.error(`exec error: ${l.message}`),y(`Error: ${l.message}
Stderr: ${g}`);return}g&&console.warn(`exec stderr: ${g}`),c(p.trim())})})}},S=class extends h.Modal{constructor(t,n){super(t);this.plugin=n}onOpen(){let{contentEl:t}=this;t.empty(),t.createEl("h2",{text:"Krems Publisher Actions"});let n=t.createDiv({cls:"krems-modal-section"});n.createEl("h4",{text:"1. Initialize Local Directory"}),n.createEl("p",{text:`This will clone krems-example into your specified local directory (${this.plugin.settings.localMarkdownPath||"not set"}) and set its remote to your GitHub repo.`});let c=n.createEl("button",{text:"Initialize Directory"}),y=n.createEl("div",{cls:"krems-feedback",attr:{style:"margin-top: 10px;"}}),l=(a,f)=>{y.textContent=a,y.className=`krems-feedback krems-feedback-${f}`};c.addEventListener("click",async()=>{let{localMarkdownPath:a,githubRepoUrl:f}=this.plugin.settings;if(!a||!f){l("Error: Local Markdown Directory and GitHub Repo URL must be set in plugin settings.","error");return}let E=this.app.vault.adapter.getBasePath(),u=x.join(E,a);try{let m=this.app.vault.adapter;if(await m.exists(u)){let k=await m.stat(u);if(k&&k.type==="folder"){let b=await m.list(u);if(b.files.length>0||b.folders.length>0){l(`Error: Directory '${a}' already exists and is not empty. Please choose an empty or new directory.`,"error");return}}else{l(`Error: Path '${a}' exists but is not a directory.`,"error");return}}}catch(m){console.log("Directory check for init:",m)}c.disabled=!0,l("Cloning krems-example repository...","status");try{let m=`git clone https://github.com/mreider/krems-example "${u}"`;await this.plugin.execShellCommand(m,E),l("Repository cloned. Setting remote URL...","status");let k=`git -C "${u}" remote set-url origin "${f}"`;await this.plugin.execShellCommand(k,E),l("Remote URL set. Cleaning up README.md...","status");let b=x.join(u,"README.md");await this.app.vault.adapter.exists(b)?(await this.app.vault.adapter.remove(b),l("Directory initialized successfully! README.md removed.","success")):l("Directory initialized successfully! (README.md not found to remove).","success")}catch(m){console.error("Initialization error:",m),l(`Initialization failed: ${m}`,"error")}finally{c.disabled=!1}}),(!this.plugin.settings.localMarkdownPath||!this.plugin.settings.githubRepoUrl)&&(c.disabled=!0,n.createEl("p",{text:"Please set Local Markdown Directory and GitHub Repo URL in settings.",cls:"krems-warning"}));let p=t.createDiv({cls:"krems-modal-section"});p.createEl("h4",{text:"3. Push Site to GitHub"}),p.createEl("p",{text:`This will add, commit, and push the content of '${this.plugin.settings.localMarkdownPath||"not set"}' to your GitHub repo.`});let g=p.createEl("input",{type:"text",placeholder:"Optional commit message (default: latest site version)"});g.style.width="100%",g.style.marginBottom="10px";let s=p.createEl("button",{text:"Push to GitHub"}),i=p.createEl("div",{cls:"krems-feedback",attr:{style:"margin-top: 10px;"}}),e=(a,f)=>{i.textContent=a,i.className=`krems-feedback krems-feedback-${f}`};s.addEventListener("click",async()=>{let{localMarkdownPath:a,githubRepoUrl:f}=this.plugin.settings;if(!a||!f){e("Error: Local Markdown Directory and GitHub Repo URL must be set in plugin settings.","error");return}let E=this.app.vault.adapter.getBasePath(),u=x.join(E,a),k=(g.value.trim()||"latest site version").replace(/"/g,'\\"');s.disabled=!0,g.disabled=!0,e("Preparing to push site...","status");try{try{await this.plugin.execShellCommand("git config user.name",u),await this.plugin.execShellCommand("git config user.email",u),e("Git user identity found. Proceeding...","status")}catch(P){e("Git user identity not found, setting default for this commit...","status"),await this.plugin.execShellCommand('git config user.name "Krems Obsidian Plugin"',u),await this.plugin.execShellCommand('git config user.email "krems-plugin@example.com"',u)}e("Adding files (git add .)...","status"),await this.plugin.execShellCommand("git add .",u),e(`Committing with message: "${k}"...`,"status");try{await this.plugin.execShellCommand(`git commit -m "${k}"`,u)}catch(P){if(P.toString().includes("nothing to commit"))e("No changes to commit. Proceeding to push...","status");else throw P}e("Pushing to remote repository...","status");let b="git push",{gitPassword:M,githubRepoUrl:w}=this.plugin.settings;if(M&&w.startsWith("https://")){let P=w.substring(8),D=`https://${M}@${P}`,C="main";try{C=await this.plugin.execShellCommand("git rev-parse --abbrev-ref HEAD",u)}catch($){console.warn("Could not determine current branch, defaulting to 'main'. Error:",$),e('Warning: Could not determine current branch, attempting to push to "main".',"status")}b=`git push ${D} ${C}`,e(`Pushing to ${w} with authentication...`,"status")}else e(`Pushing to ${w} (no token/password provided or not HTTPS URL)...`,"status");await this.plugin.execShellCommand(b,u),e("Site pushed successfully!","success")}catch(b){console.error("Push error:",b),e(`Push failed: ${b}`,"error")}finally{s.disabled=!1,g.disabled=!1}}),(!this.plugin.settings.localMarkdownPath||!this.plugin.settings.githubRepoUrl)&&(s.disabled=!0,g.disabled=!0,p.createEl("p",{text:"Please set Local Markdown Directory and GitHub Repo URL in settings.",cls:"krems-warning"})),t.createEl("hr");let r=t.createEl("p",{cls:"krems-modal-footer"});r.setText("For help, see the "),r.createEl("a",{text:"plugin documentation",href:"https://github.com/mreider/krems-obsidian-plugin/",attr:{target:"_blank",rel:"noopener noreferrer"}}),r.appendText(".")}onClose(){let{contentEl:t}=this;t.empty()}},L=class extends h.PluginSettingTab{constructor(t,n){super(t,n);this.plugin=n}display(){let{containerEl:t}=this;t.empty(),t.createEl("h2",{text:"Krems Publisher Settings"});let n=(s,i,e,r)=>{s.classList.remove("krems-input-valid","krems-input-invalid"),i.classList.remove("krems-feedback-valid","krems-feedback-invalid"),i.textContent=e,i.style.display=e?"block":"none",e&&(s.classList.add(r?"krems-input-valid":"krems-input-invalid"),i.classList.add(r?"krems-feedback-valid":"krems-feedback-invalid"))},c=new h.Setting(t).setName("GitHub Repository URL").setDesc("HTTPS URL of your GitHub repository (e.g., https://github.com/username/repo). Do not include .git at the end."),y=c.controlEl.createEl("div",{cls:"krems-setting-feedback",attr:{id:"repo-url-feedback",style:"display: none; margin-top: 5px;"}});c.addText(s=>{s.setPlaceholder("https://github.com/username/repo").setValue(this.plugin.settings.githubRepoUrl).onChange(async i=>{this.plugin.settings.githubRepoUrl=i.trim(),await this.plugin.saveSettings()}),s.inputEl.addEventListener("focusout",async()=>{let i=this.plugin.settings.githubRepoUrl,e=!0,r="";if(!i){n(s.inputEl,y,"",!0);return}if(!i.startsWith("https://github.com/"))e=!1,r="URL must start with https://github.com/";else if(i.endsWith(".git"))e=!1,r="URL should not end with .git";else{let a=i.substring(19).split("/");(a.length<2||!a[0]||!a[1])&&(e=!1,r="Invalid GitHub repository URL format.")}e&&r===""&&(r="URL format is valid."),n(s.inputEl,y,r,e)}),this.plugin.settings.githubRepoUrl&&s.inputEl.dispatchEvent(new Event("focusout"))});let l=new h.Setting(t).setName("Local Markdown Directory").setDesc("Path to the directory in your vault for your Krems site (e.g., MyKremsSite)."),p=l.controlEl.createEl("div",{cls:"krems-setting-feedback",attr:{id:"local-path-feedback",style:"display: none; margin-top: 5px;"}});l.addText(s=>{s.setPlaceholder("e.g., MyKremsSite or path/to/site").setValue(this.plugin.settings.localMarkdownPath).onChange(async i=>{this.plugin.settings.localMarkdownPath=i.trim(),await this.plugin.saveSettings()}),s.inputEl.addEventListener("focusout",async()=>{let i=this.plugin.settings.localMarkdownPath,e=!1,r="";if(!i){n(s.inputEl,p,"",!0);return}let a=this.app.vault.getAbstractFileByPath(i);a&&a instanceof h.TFolder?(e=!0,r="Directory exists."):(e=!1,r="Directory not found in the vault."),n(s.inputEl,p,r,e)}),this.plugin.settings.localMarkdownPath&&s.inputEl.dispatchEvent(new Event("focusout"))}),new h.Setting(t).setName("Git Token/Password (Optional)").setDesc("Enter your Git password or Personal Access Token (PAT) if required for push operations. PAT is recommended for security.").addText(s=>{s.inputEl.type="password",s.setPlaceholder("Enter your Git token/password").setValue(this.plugin.settings.gitPassword||"").onChange(async i=>{this.plugin.settings.gitPassword=i,await this.plugin.saveSettings()})}),t.createEl("hr");let g=t.createEl("p",{cls:"krems-settings-footer"});g.setText("For plugin instructions, troubleshooting, and more information, please visit the "),g.createEl("a",{text:"plugin documentation on GitHub",href:"https://github.com/mreider/krems-obsidian-plugin/",attr:{target:"_blank",rel:"noopener noreferrer"}}),g.setText(".")}};
