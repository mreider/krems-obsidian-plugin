/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/

var q=Object.create;var M=Object.defineProperty;var Z=Object.getOwnPropertyDescriptor;var Q=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,tt=Object.prototype.hasOwnProperty;var et=(h,w)=>{for(var e in w)M(h,e,{get:w[e],enumerable:!0})},V=(h,w,e,i)=>{if(w&&typeof w=="object"||typeof w=="function")for(let d of Q(w))!tt.call(h,d)&&d!==e&&M(h,d,{get:()=>w[d],enumerable:!(i=Z(w,d))||i.enumerable});return h};var J=(h,w,e)=>(e=h!=null?q(X(h)):{},V(w||!h||!h.__esModule?M(e,"default",{value:h,enumerable:!0}):e,h)),st=h=>V(M({},"__esModule",{value:!0}),h);var it={};et(it,{default:()=>$});module.exports=st(it);var g=require("obsidian"),E=J(require("path")),H=J(require("fs")),D=require("child_process"),z={githubRepoUrl:"",localMarkdownPath:"",gitPassword:"",gitAuthorName:"",gitAuthorEmail:"",localRunPort:"8080",localKremsBinaryPath:"",alternativeCSSDir:"",alternativeJSDir:"",alternativeFavicon:""},$=class extends g.Plugin{constructor(){super(...arguments);this.isKremsLocallyRunning=!1;this.localKremsProcess=null}async onload(){await this.loadSettings(),this.addRibbonIcon("cloud-lightning","Krems Publisher",e=>{new I(this.app,this).open()}),this.addSettingTab(new G(this.app,this)),console.log("Krems Obsidian Plugin loaded.")}onunload(){this.localKremsProcess&&(console.log("Krems Obsidian Plugin unloading: Killing active Krems process."),this.localKremsProcess.kill(),this.localKremsProcess=null,this.isKremsLocallyRunning=!1),console.log("Krems Obsidian Plugin unloaded.")}async loadSettings(){this.settings=Object.assign({},z,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async execShellCommand(e,i,d,t){return new Promise((s,o)=>{let n=d?{...process.env,...d}:process.env,r=t||e;(0,D.exec)(e,{cwd:i,env:n},(u,P,m)=>{let y={stdout:P.trim(),stderr:m.trim()};if(u){console.error(`Command failed: ${r}
Error: ${u.message}
Stdout: ${y.stdout}
Stderr: ${y.stderr}`),o({message:`Command failed: ${r}. Error: ${u.message}`,stdout:y.stdout,stderr:y.stderr,originalError:u});return}y.stderr&&console.warn(`Command successful but stderr present: ${r}
Stderr: ${y.stderr}`),s(y)})})}getKremsBinaryDir(){return E.join(this.app.vault.configDir,"plugins",this.manifest.id,"bin")}getKremsBinaryName(){switch(process.platform){case"win32":return"krems-windows-amd64.exe";case"darwin":return"krems-darwin-amd64";case"linux":return"krems-linux-amd64";default:return""}}async ensureKremsBinary(e){let i=this.getKremsBinaryName();if(!i)return e("Unsupported operating system for Krems download.","error"),null;let d=this.getKremsBinaryDir(),t=E.join(d,i),s=this.app.vault.adapter.getBasePath(),o=E.join(s,t);this.settings.localKremsBinaryPath=t,await this.saveSettings();let n=this.app.vault.adapter;try{if(await n.exists(t)){if(e("Krems binary already downloaded.","status"),process.platform!=="win32")try{H.chmodSync(o,493)}catch(r){return console.error("Failed to chmod existing binary:",r),e("Found Krems binary, but failed to set executable permission. Please check manually.","error"),null}return t}}catch(r){console.error("Error checking for existing Krems binary:",r),e("Error checking for existing Krems binary. Attempting download.","error")}e(`Downloading Krems for ${process.platform}...`,"status");try{await n.exists(d)||await n.mkdir(d);let r=`https://github.com/mreider/krems/releases/latest/download/${i}`,u=await(0,g.requestUrl)({url:r,method:"GET"});if(u.status!==200)throw new Error(`Failed to download Krems: Server responded with ${u.status}`);return await n.writeBinary(t,u.arrayBuffer),e("Krems downloaded successfully.","status"),process.platform!=="win32"&&(e("Setting executable permissions...","status"),H.chmodSync(o,493),e("Permissions set.","status")),t}catch(r){return console.error("Krems download error:",r),e(`Failed to download Krems: ${r.message||r.toString()}`,"error"),null}}},I=class extends g.Modal{constructor(e,i){super(e);this.plugin=i}async checkIfDirIsEmpty(e){try{let d=await this.app.vault.adapter.list(e);return d.files.length===0&&d.folders.length===0}catch(i){return console.warn(`Error listing contents of '${e}':`,i),!1}}async onOpen(){let{contentEl:e}=this;e.empty(),e.createEl("h2",{text:"Krems Publisher Actions"});let i=e.createDiv({cls:"krems-modal-section"});i.createEl("h4",{text:"1. Clone Your Repo"});let d=i.createEl("p",{text:`This will clone your repo from GitHub into your specified local directory (${this.plugin.settings.localMarkdownPath||"not set"}).`});this.initButton=i.createEl("button",{text:"Clone Your Repo"}),this.initFeedbackEl=i.createEl("div",{cls:"krems-feedback",attr:{style:"margin-top: 10px;"}});let t=i.createEl("p",{cls:"krems-warning",attr:{style:"display: none;"}}),s=(l,a)=>{this.initFeedbackEl.textContent=l,this.initFeedbackEl.className=`krems-feedback krems-feedback-${a}`},o=this.plugin.settings.localMarkdownPath,n=!!this.plugin.settings.githubRepoUrl;!o||!n?(this.initButton.disabled=!0,t.textContent="Please set Local Markdown Directory and GitHub Repo URL in settings.",t.style.display="block"):this.app.vault.adapter.stat(o).then(async a=>{a?a.type==="folder"?await this.checkIfDirIsEmpty(o)?(t.style.display="none",this.initButton.disabled=!1):(this.initButton.disabled=!0,t.textContent=`Directory '${o}' is not empty. Can only initialize empty directories.`,t.style.display="block"):(this.initButton.disabled=!0,t.textContent=`Path '${o}' is a file, not a directory. Initialization requires a directory path.`,t.style.display="block"):(t.style.display="none",this.initButton.disabled=!1)}).catch(a=>{console.error(`Error checking path '${o}' for init button state:`,a),this.initButton.disabled=!0,t.textContent="Error checking local directory status. Initialization disabled.",t.style.display="block"}),this.initButton.addEventListener("click",async()=>{let{localMarkdownPath:l,githubRepoUrl:a}=this.plugin.settings;if(!l||!a){s("Error: Local Markdown Directory and GitHub Repo URL must be set in plugin settings.","error");return}let v=this.app.vault.adapter.getBasePath(),S=E.join(v,l);if(await this.app.vault.adapter.exists(l)&&!await this.checkIfDirIsEmpty(l)){s(`Error: Directory '${l}' is not empty. Please choose an empty or new directory.`,"error");return}this.initButton.disabled=!0,s(`Cloning your repository from ${a}...`,"status");try{let f=`git clone ${a} "${S}"`;await this.plugin.execShellCommand(f,v,void 0,"git clone <your-repo-url> <path>"),s("Repository cloned successfully!","success")}catch(f){console.error("Cloning error:",f.message||f);let k=f.stderr||f.message||f.toString();s(`Cloning failed: ${k}`,"error")}finally{this.initButton.disabled=!1}});let r=e.createDiv({cls:"krems-modal-section"});r.createEl("h4",{text:"2. Preview Site Locally"}),this.browseLocallyButton=r.createEl("button",{text:"Browse Locally"}),this.stopKremsButton=r.createEl("button",{text:"Stop Local Server"});let u=r.createEl("div",{cls:"krems-feedback",attr:{style:"margin-top: 10px; white-space: pre-wrap; background-color: var(--background-secondary); padding: 5px; border-radius: 3px; max-height: 150px; overflow-y: auto;"}}),P=r.createEl("p",{cls:"krems-warning",attr:{style:"display: none;"}}),m=(l,a)=>{a==="log"?(u.textContent+=l+`
`,u.scrollTop=u.scrollHeight):u.textContent=l,u.className=`krems-feedback krems-feedback-${a}`},y=()=>{this.plugin.isKremsLocallyRunning?(this.browseLocallyButton.setText("Server Running"),this.browseLocallyButton.disabled=!0,this.stopKremsButton.disabled=!1):(this.browseLocallyButton.setText("Browse Locally"),this.browseLocallyButton.disabled=!1,this.stopKremsButton.disabled=!0);let{localMarkdownPath:l}=this.plugin.settings;l?P.style.display="none":(this.browseLocallyButton.disabled=!0,this.stopKremsButton.disabled=!0,P.textContent="Please set Local Markdown Directory in settings.",P.style.display="block")};y(),this.browseLocallyButton.addEventListener("click",async()=>{var C,c;let{localMarkdownPath:l,localRunPort:a}=this.plugin.settings;if(!l){m("Error: Local Markdown Directory must be set.","error");return}if(this.browseLocallyButton.disabled=!0,m("Preparing local preview...","status"),!confirm("To preview your site locally, this will download the Krems binary (if not already present) and set executable permissions. This step is for local preview and not strictly necessary for publishing to GitHub. Is it okay to proceed?")){m("Local preview cancelled by user.","status"),y();return}let S=await this.plugin.ensureKremsBinary(m);if(!S){y();return}let f=this.app.vault.adapter.getBasePath(),k=E.join(f,S),x=E.join(f,l),B=a||z.localRunPort||"8080";m(`Starting Krems server on port ${B}...`,"status");try{this.plugin.localKremsProcess=(0,D.spawn)(k,["--run","--port",B],{cwd:x,shell:process.platform==="win32"}),this.plugin.isKremsLocallyRunning=!0,y(),m(`Krems server starting on port ${B}. Output:
`,"log"),setTimeout(()=>{window.open(`http://localhost:${B}`,"_blank")},1500),(C=this.plugin.localKremsProcess.stdout)==null||C.on("data",p=>{m(p.toString(),"log")}),(c=this.plugin.localKremsProcess.stderr)==null||c.on("data",p=>{m(`[STDERR] ${p.toString()}`,"log")}),this.plugin.localKremsProcess.on("error",p=>{console.error("Failed to start Krems process:",p),m(`Failed to start Krems: ${p.message}`,"error"),this.plugin.isKremsLocallyRunning=!1,this.plugin.localKremsProcess=null,y()}),this.plugin.localKremsProcess.on("close",p=>{m(`Krems server exited with code ${p}.`,p===0?"status":"error"),this.plugin.isKremsLocallyRunning=!1,this.plugin.localKremsProcess=null,y()})}catch(p){console.error("Error spawning Krems:",p),m(`Error starting Krems: ${p.message||p.toString()}`,"error"),this.plugin.isKremsLocallyRunning=!1,this.plugin.localKremsProcess=null,y()}}),this.stopKremsButton.addEventListener("click",async()=>{this.plugin.localKremsProcess?(m("Stopping Krems server...","status"),this.plugin.localKremsProcess.kill()):(m("Krems server is not running.","status"),this.plugin.isKremsLocallyRunning=!1,y());let l=this.plugin.settings.localKremsBinaryPath,{localMarkdownPath:a}=this.plugin.settings;if(l&&a){let v=this.app.vault.adapter.getBasePath(),S=E.join(v,a),f=E.join(v,l);m("Cleaning up .tmp directory...","status");try{await this.plugin.execShellCommand(`"${f}" --clean`,S,void 0,"krems --clean"),m("Cleanup successful.","status")}catch(k){console.error("Krems clean error:",k),m(`Cleanup failed: ${k.stderr||k.message}`,"error")}}});let K=e.createDiv({cls:"krems-modal-section"});K.createEl("h4",{text:"3. Push Site to GitHub"}),K.createEl("p",{text:`This will add, commit, and push the content of '${this.plugin.settings.localMarkdownPath||"not set"}' to your GitHub repo.`});let L=K.createEl("input",{type:"text",placeholder:"Optional commit message (default: latest site version)"});L.style.width="100%",L.style.marginBottom="10px";let T=K.createEl("button",{text:"Push to GitHub"}),O=K.createEl("div",{cls:"krems-feedback",attr:{style:"margin-top: 10px;"}}),b=(l,a)=>{O.textContent=l,O.className=`krems-feedback krems-feedback-${a}`};T.addEventListener("click",async()=>{let{localMarkdownPath:l,githubRepoUrl:a,gitAuthorName:v,gitAuthorEmail:S,gitPassword:f}=this.plugin.settings;if(!l||!a){b("Error: Local Markdown Directory and GitHub Repo URL must be set in plugin settings.","error");return}let k=this.app.vault.adapter.getBasePath(),x=E.join(k,l),C=(L.value.trim()||"latest site version").replace(/"/g,'\\"');T.disabled=!0,L.disabled=!0,b("Preparing to push site...","status");try{let c;b("Adding files (git add .)...","status"),c=await this.plugin.execShellCommand("git add .",x),c.stderr&&b(`Git add (warnings): ${c.stderr}`,"status"),b(`Committing with message: "${C}"...`,"status");let p=v||"Krems Obsidian Plugin",U=S||"krems-plugin@example.com",W={GIT_AUTHOR_NAME:p,GIT_AUTHOR_EMAIL:U,GIT_COMMITTER_NAME:p,GIT_COMMITTER_EMAIL:U};try{c=await this.plugin.execShellCommand(`git commit -m "${C}"`,x,W),c.stderr&&b(`Git commit (warnings): ${c.stderr}`,"status")}catch(R){if(R.stdout&&R.stdout.includes("nothing to commit"))b("No changes to commit. Proceeding to push...","status");else throw R}b("Pushing to remote repository...","status");let _="git push",j="git push";if(f&&a.startsWith("https://")){let R=a.substring(8),Y=`https://${f}@${R}`,N="main";try{c=await this.plugin.execShellCommand("git rev-parse --abbrev-ref HEAD",x),N=c.stdout,c.stderr&&b(`Git branch check (warnings): ${c.stderr}`,"status")}catch(F){console.warn("Could not determine current branch, defaulting to 'main'. Error:",F.message),b(`Warning: Could not determine current branch (using 'main'). Details: ${F.stderr||F.message}`,"status")}_=`git push ${Y} ${N}`,j=`git push <authenticated_url> ${N}`,b(`Pushing to ${a} (authenticated)...`,"status")}else b(`Pushing to ${a} (unauthenticated, ensure credential helper or SSH is set up)...`,"status");c=await this.plugin.execShellCommand(_,x,void 0,j),c.stderr?b(`Push successful with warnings: ${c.stderr}`,"success"):b("Site pushed successfully!","success")}catch(c){console.error("Push error:",c.message||c);let p=`Push failed: ${c.message||c.toString()}${c.stderr?`
Stderr: ${c.stderr}`:""}`;b(p,"error")}finally{T.disabled=!1,L.disabled=!1}}),(!this.plugin.settings.localMarkdownPath||!this.plugin.settings.githubRepoUrl)&&(T.disabled=!0,L.disabled=!0,K.createEl("p",{text:"Please set Local Markdown Directory and GitHub Repo URL in settings.",cls:"krems-warning"})),e.createEl("hr");let A=e.createEl("p",{cls:"krems-modal-footer"});A.setText("For help, see the "),A.createEl("a",{text:"plugin documentation",href:"https://github.com/mreider/krems-obsidian-plugin/",attr:{target:"_blank",rel:"noopener noreferrer"}}),A.appendText(".")}onClose(){let{contentEl:e}=this;e.empty()}},G=class extends g.PluginSettingTab{constructor(e,i){super(e,i);this.plugin=i}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Krems Publisher Settings"});let i=(t,s,o,n)=>{t.classList.remove("krems-input-valid","krems-input-invalid"),s.classList.remove("krems-feedback-valid","krems-feedback-invalid"),s.textContent=o,s.style.display=o?"block":"none",o&&(t.classList.add(n?"krems-input-valid":"krems-input-invalid"),s.classList.add(n?"krems-feedback-valid":"krems-feedback-invalid"))};new g.Setting(e).setName("GitHub Repository URL").setDesc("Git URL of your Krems repository (e.g., git@github.com:username/repo.git).").addText(t=>{var o;let s=(o=t.inputEl.parentElement)==null?void 0:o.createEl("div",{cls:"krems-setting-feedback",attr:{style:"display: none; margin-top: 5px;"}});t.setPlaceholder("git@github.com:username/repo.git").setValue(this.plugin.settings.githubRepoUrl).onChange(async n=>{this.plugin.settings.githubRepoUrl=n.trim(),await this.plugin.saveSettings()}),t.inputEl.addEventListener("focusout",async()=>{let n=this.plugin.settings.githubRepoUrl,r=!0,u="";if(!n){i(t.inputEl,s,"",!0);return}/^git@github\.com:[a-zA-Z0-9_-]+\/[a-zA-Z0-9._-]+(\.git)?$/.test(n)?u="URL format is valid.":(r=!1,u="Invalid format. Use git@github.com:user/repo.git"),i(t.inputEl,s,u,r)}),this.plugin.settings.githubRepoUrl&&t.inputEl.dispatchEvent(new Event("focusout"))}),new g.Setting(e).setName("Local Markdown Directory").setDesc("Path to the directory in your vault for your Krems site (e.g., MyKremsSite).").addText(t=>{var o;let s=(o=t.inputEl.parentElement)==null?void 0:o.createEl("div",{cls:"krems-setting-feedback",attr:{style:"display: none; margin-top: 5px;"}});t.setPlaceholder("e.g., MyKremsSite or path/to/site").setValue(this.plugin.settings.localMarkdownPath).onChange(async n=>{this.plugin.settings.localMarkdownPath=n.trim(),await this.plugin.saveSettings()}),t.inputEl.addEventListener("focusout",async()=>{let n=this.plugin.settings.localMarkdownPath,r=!1,u="";if(!n){i(t.inputEl,s,"",!0);return}let P=this.app.vault.getAbstractFileByPath(n);P&&P instanceof g.TFolder?(r=!0,u="Directory exists."):(r=!1,u="Directory not found in the vault."),i(t.inputEl,s,u,r)}),this.plugin.settings.localMarkdownPath&&t.inputEl.dispatchEvent(new Event("focusout"))}),new g.Setting(e).setName("GitHub Personal Access Token (PAT)").setDesc('Required for pushing to HTTPS repositories. Create a PAT on GitHub with "repo" and "workflow" scopes. See plugin README for instructions.').addText(t=>{t.inputEl.type="password",t.setPlaceholder("Enter your GitHub PAT").setValue(this.plugin.settings.gitPassword||"").onChange(async s=>{this.plugin.settings.gitPassword=s,await this.plugin.saveSettings()})}),new g.Setting(e).setName("Git Author Name").setDesc('Name to use for Git commits (e.g., Your Name). If blank, a default ("Krems Obsidian Plugin") will be used.').addText(t=>t.setPlaceholder("Your Name").setValue(this.plugin.settings.gitAuthorName||"").onChange(async s=>{this.plugin.settings.gitAuthorName=s.trim(),await this.plugin.saveSettings()})),new g.Setting(e).setName("Git Author Email").setDesc('Email to use for Git commits (e.g., your.email@example.com). If blank, a default ("krems-plugin@example.com") will be used.').addText(t=>t.setPlaceholder("your.email@example.com").setValue(this.plugin.settings.gitAuthorEmail||"").onChange(async s=>{this.plugin.settings.gitAuthorEmail=s.trim(),await this.plugin.saveSettings()})),new g.Setting(e).setName("Port for Local Server (Optional)").setDesc('Port for "Browse Locally" feature. Defaults to 8080 if blank or invalid.').addText(t=>{var o;let s=(o=t.inputEl.parentElement)==null?void 0:o.createEl("div",{cls:"krems-setting-feedback",attr:{style:"display: none; margin-top: 5px;"}});t.setPlaceholder("e.g., 8080").setValue(this.plugin.settings.localRunPort||"").onChange(async n=>{this.plugin.settings.localRunPort=n.trim(),await this.plugin.saveSettings()}),t.inputEl.addEventListener("focusout",()=>{let n=this.plugin.settings.localRunPort;if(!n){i(t.inputEl,s,"Using default port 8080.",!0);return}let r=parseInt(n,10);isNaN(r)||r<1024||r>65535?i(t.inputEl,s,"Invalid port. Must be a number between 1024-65535.",!1):i(t.inputEl,s,"Port is valid.",!0)}),this.plugin.settings.localRunPort&&t.inputEl.dispatchEvent(new Event("focusout"))}),e.createEl("h3",{text:"Alternative Asset Paths (Optional)"}),e.createEl("p",{text:'Specify paths relative to your "Local Markdown Directory" for custom CSS, JS, or favicon. If left blank, Krems defaults will be used.'}),new g.Setting(e).setName("Alternative CSS Directory").setDesc('Path to a directory containing your custom .css files (e.g., "my-styles/css").').addText(t=>t.setPlaceholder("e.g., assets/css").setValue(this.plugin.settings.alternativeCSSDir||"").onChange(async s=>{this.plugin.settings.alternativeCSSDir=s.trim(),await this.plugin.saveSettings()})),new g.Setting(e).setName("Alternative JS Directory").setDesc('Path to a directory containing your custom .js files (e.g., "my-scripts/js").').addText(t=>t.setPlaceholder("e.g., assets/js").setValue(this.plugin.settings.alternativeJSDir||"").onChange(async s=>{this.plugin.settings.alternativeJSDir=s.trim(),await this.plugin.saveSettings()})),new g.Setting(e).setName("Alternative Favicon File").setDesc('Path to your custom favicon file (e.g., "my-images/favicon.png").').addText(t=>t.setPlaceholder("e.g., assets/images/custom-favicon.ico").setValue(this.plugin.settings.alternativeFavicon||"").onChange(async s=>{this.plugin.settings.alternativeFavicon=s.trim(),await this.plugin.saveSettings()})),e.createEl("hr");let d=e.createEl("p",{cls:"krems-settings-footer"});d.setText("For plugin instructions, troubleshooting, and more information, please visit the "),d.createEl("a",{text:"plugin documentation on GitHub",href:"https://github.com/mreider/krems-obsidian-plugin/",attr:{target:"_blank",rel:"noopener noreferrer"}}),d.appendText(".")}};
